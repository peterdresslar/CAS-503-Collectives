<!DOCTYPE html>
<html>
<head>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
    }
    canvas {
      display: block;
      box-sizing: border-box;
      width: 99%;   /* fill iframe width minus the percent for the border */
      height: 500px;   /* fill iframe height */
      border: 1px solid #d3d3d3;
    }
  </style>
</head>

<body>
  <canvas id="boids"></canvas>

  <script src="./boids-live.js"></script>

  <script>
    function sendMessageToStreamlitClient(type, data) {
      var outData = Object.assign({ isStreamlitMessage: true, type: type }, data);
      window.parent.postMessage(outData, "*");
    }
    function init() { sendMessageToStreamlitClient("streamlit:componentReady", { apiVersion: 1 }); }
    // Streamlit already sets iframe height from the Python `height=` argument.
    // We keep a helper around in case you later make the height dynamic.
    function setFrameHeight(height) { sendMessageToStreamlitClient("streamlit:setFrameHeight", { height: height }); }
    // Streamlit doesn't fully register the component until it sends the first
    // `streamlit:render`. If we send a component value before that, Streamlit logs:
    // "Received component message for unregistered ComponentInstance".
    let hasSeenRender = false;
    function sendDataToPython(data) {
      if (!hasSeenRender) return;
      sendMessageToStreamlitClient("streamlit:setComponentValue", { value: data });
    }

    const FRAME_HEIGHT = 500;

    function resizeCanvasToCSSSize() {
      const canvas = document.getElementById("boids");
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1; // dpr is fairly well supported but not universal: https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio

      // match drawing buffer to displayed size (important for crispness + correct sim bounds)
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);

      const ctx = canvas.getContext("2d"); // critical for correct simulation bounds available to boids-live.js
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener("load", function () {
      // Delay slightly so Streamlit has time to register the component message handler.
      setTimeout(init, 0);

      // Let layout settle, then size canvas + init sim
      requestAnimationFrame(() => {
        resizeCanvasToCSSSize();
        if (window.BOIDS) {
          window.BOIDS.init({ canvasId: "boids", sendTelemetry: sendDataToPython });
        }
      });
    });

    window.addEventListener("resize", () => {
      // Only send frame-height messages after Streamlit has rendered at least once.
      if (hasSeenRender) setFrameHeight(FRAME_HEIGHT);
      requestAnimationFrame(() => {
        resizeCanvasToCSSSize();
        if (window.BOIDS) window.BOIDS.resize();
      });
    });

    window.addEventListener("message", function (event) {
      if (event.data.type !== "streamlit:render") return;
      hasSeenRender = true;
      const args = event.data.args || {};
      if (!window.BOIDS) return;

      if (args.params) window.BOIDS.setParams(args.params);
      if (args.command === "start") window.BOIDS.start();
      if (args.command === "stop") window.BOIDS.stop();
      if (args.command === "reload") window.BOIDS.reload();
    });
  </script>
</body>
</html>