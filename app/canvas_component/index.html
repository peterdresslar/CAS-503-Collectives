<!DOCTYPE html>
<html>
<head>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
    }
    canvas {
      display: block;
      box-sizing: border-box;
      width: 99%;   /* fill iframe width minus the percent for the border */
      height: 500px;   /* fill iframe height */
      border: 1px solid #d3d3d3;
    }
  </style>
</head>

<body>
  <canvas id="boids"></canvas>

  <script src="./boids-live.js"></script>

  <script>
    function sendMessageToStreamlitClient(type, data) {
      var outData = Object.assign({ isStreamlitMessage: true, type: type }, data);
      window.parent.postMessage(outData, "*");
    }
    function init() { sendMessageToStreamlitClient("streamlit:componentReady", { apiVersion: 1 }); }
    function setFrameHeight(height) { sendMessageToStreamlitClient("streamlit:setFrameHeight", { height: height }); }
    function sendDataToPython(data) { sendMessageToStreamlitClient("streamlit:setComponentValue", { value: data }); }

    const FRAME_HEIGHT = 500;

    function resizeCanvasToCSSSize() {
      const canvas = document.getElementById("boids");
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      // match drawing buffer to displayed size (important for crispness + correct sim bounds)
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);

      // if your boids code uses ctx pixels directly, you may also want:
      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener("load", function () {
      init();

      // Important: assert a non-zero iframe height up-front (avoids Chrome 0px feedback loop)
      setFrameHeight(FRAME_HEIGHT);

      // Let layout settle, then size canvas + init sim
      requestAnimationFrame(() => {
        resizeCanvasToCSSSize();
        if (window.BOIDS) {
          window.BOIDS.init({ canvasId: "boids", sendTelemetry: sendDataToPython });
        }
      });
    });

    window.addEventListener("resize", () => {
      setFrameHeight(FRAME_HEIGHT);
      requestAnimationFrame(() => {
        resizeCanvasToCSSSize();
        if (window.BOIDS) window.BOIDS.resize();
      });
    });

    window.addEventListener("message", function (event) {
      if (event.data.type !== "streamlit:render") return;
      const args = event.data.args || {};
      if (!window.BOIDS) return;

      if (args.params) window.BOIDS.setParams(args.params);
      if (args.command === "start") window.BOIDS.start();
      if (args.command === "stop") window.BOIDS.stop();
      if (args.command === "reload") window.BOIDS.reload();

      // Keep height asserted after Streamlit renders
      setFrameHeight(FRAME_HEIGHT);
    });
  </script>
</body>
</html>